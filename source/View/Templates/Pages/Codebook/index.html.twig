{% extends "Layouts/codebook.html.twig" %}
{% from "Components/_macros.html.twig" import inputLabels %}
{% from "Components/_macros.html.twig" import copyToVariables %}
{% from "Components/_macros.html.twig" import codebookHelp %}

{% block body %}
    <main class="content col-span-full md:col-start-1 md:col-end-10">
        <div class="flex flex-col">
            <div class="">
                <div class="inline-block min-w-full align-middle">
                    {# <div class="border-b border-gray-400 overflow-y-auto max-h-[calc(100vh-3.5rem)]"> #}
                    <div class="border-b border-gray-400">
                        <table class="min-w-full border-separate table-fixed" style="border-spacing: 0">
                            <thead class="sticky top-[3.5rem] z-10">
                            <tr>
                                <th scope="col"
                                    class="pl-3 pr-1 text-sm text-left text-gray-700 border-b border-mono-500 bg-mono-200">
                                    <input type="checkbox" name="" id="">
                                </th>
                                <th scope="col" class="CodeBookHead-Cell">
                                    <span class="sr-only">ID</span>
                                </th>
                                <th scope="col" class="CodeBookHead-Cell w-[15%]">
                                    Variable name
                                    <button class="inline-flex items-center justify-center w-6 h-6 ml-0 MetaData-HelpButton"
                                            @click="$store.codebookSettings.showHelp.sideBar = true; $store.codebookSettings.showHelp.variableName = true">
                                        ?
                                    </button>
                                    </span>
                                </th>
                                <th scope="col" class="CodeBookHead-Cell w-[20%]">
                                    Label
                                    <button class="inline-flex items-center justify-center w-6 h-6 ml-0 MetaData-HelpButton"
                                            @click="$store.codebookSettings.showHelp.sideBar = true; $store.codebookSettings.showHelp.variableLabel = true">
                                        ?
                                    </button>
                                </th>
                                <th scope="col" class="CodeBookHead-Cell w-[20%]">
                                    Item text
                                    <button class="inline-flex items-center justify-center w-6 h-6 ml-0 MetaData-HelpButton"
                                            @click="$store.codebookSettings.showHelp.sideBar = true; $store.codebookSettings.showHelp.itemText = true">
                                        ?
                                    </button>
                                </th>
                                <th scope="col" class="CodeBookHead-Cell w-[15%]">
                                    Value labels
                                    <button class="inline-flex items-center justify-center w-6 h-6 ml-0 MetaData-HelpButton"
                                            @click="$store.codebookSettings.showHelp.sideBar = true; $store.codebookSettings.showHelp.valueLabels = true">
                                        ?
                                    </button>
                                </th>
                                <th scope="col" class="CodeBookHead-Cell w-[15%]">
                                    Missings
                                    <button class="inline-flex items-center justify-center w-6 h-6 ml-0 MetaData-HelpButton"
                                            @click="$store.codebookSettings.showHelp.sideBar = true; $store.codebookSettings.showHelp.missings = true">
                                        ?
                                    </button>
                                </th>
                                <th scope="col" class="CodeBookHead-Cell w-[15%]">
                                    Measure
                                    <button class="inline-flex items-center justify-center w-6 h-6 ml-0 MetaData-HelpButton"
                                            @click="$store.codebookSettings.showHelp.sideBar = true; $store.codebookSettings.showHelp.measure = true">
                                        ?
                                    </button>
                                </th>
                            </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-400">
                            <template x-for="(item, index) in filteredVariables" :key="index">
                                <tr class="even:bg-mono-100 odd:bg-mono-50 TableRow"
                                    @mousedown="$store.codebook.currentVariableID = item.id; $store.codebookSettings.showHelp.sideBar = false"
                                    :class="item.id === $store.codebook.currentVariableID ? '!bg-sky-100' : ''">
                                    <td class="pl-3 pr-1 text-sm text-gray-700">
                                        <input type="checkbox" name="" id=""
                                               @focus="$store.codebook.currentVariableID = item.id">
                                    </td>
                                    <td class="items-center px-1 text-sm text-right text-gray-700">
                                        <a href="#" class="inline-flex border-b-[1px] border-mono-900 items-center"
                                           @focus="$store.codebook.currentVariableID = item.id">
                                            <span x-text="item.id" :id="`variable_${item.id}`"></span>
                                            {# <span class="mt-0.5 iconify" data-icon="line-md:rotate-180" data-inline="false"></span> #}
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"
                                                 focusable="false" width="1em" height="1em"
                                                 style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);"
                                                 preserveaspectratio="xMidYMid meet" viewbox="0 0 24 24">
                                                <g fill="none">
                                                    <path d="M12 6a6 6 0 0 1 0 12H9.5" stroke="#626262" stroke-width="2"
                                                          stroke-linecap="round"
                                                          class="il-md-length-25 il-md-duration-4 il-md-delay-0"/>
                                                    <path d="M9 18l3 3" stroke="#626262" stroke-width="2"
                                                          stroke-linecap="round"
                                                          class="il-md-length-15 il-md-duration-2 il-md-delay-4"/>
                                                    <path d="M9 18l3-3" stroke="#626262" stroke-width="2"
                                                          stroke-linecap="round"
                                                          class="il-md-length-15 il-md-duration-2 il-md-delay-4"/>
                                                </g>
                                            </svg>
                                        </a>
                                    </td>
                                    {# Variable name #}
                                    <td class="w-[15%] text-sm">
                                        <input class="w-full p-1 text-gray-700 border"
                                               x-model="$store.codebook.getOriginalVariable(item.id).name"
                                               @focus="$store.codebook.currentVariableID = item.id">
                                    </td>
                                    {# Label #}
                                    <td class="w-[20%] py-1 text-sm">
                                        <input class="w-full p-1 text-gray-700 border"
                                               x-model="$store.codebook.getOriginalVariable(item.id).label"
                                               @focus="$store.codebook.currentVariableID = item.id">
                                    </td>
                                    {# Instruction #}
                                    <td class="w-[20%] text-sm">
                                        <input class="w-full p-1 text-gray-700 border"
                                               x-model="$store.codebook.getOriginalVariable(item.id).itemText"
                                               @focus="$store.codebook.currentVariableID = item.id">
                                    </td>
                                    {# Value labels #}
                                    <td class="w-[15%] text-sm text-gray-700 max-w-0">
                                        <template
                                                x-if="$store.codebook.getOriginalVariable(item.id).values.length === 0 || $store.codebook.getOriginalVariable(item.id).values[0].name === ''">
                                            <button class=""
                                                    @click="$store.codebook.currentVariableID = item.id; document.querySelector(`.CodeInput_values_${ $store.codebook.getOriginalVariable(item.id).values.length - 1}`).focus()"
                                                    @focus="$store.codebook.currentVariableID = item.id">
                                                Add
                                            </button>
                                        </template>
                                        <template
                                                x-if="$store.codebook.getOriginalVariable(item.id).values.length > 0 && $store.codebook.getOriginalVariable(item.id).values[0].name !== ''">
                                            <a class="block p-1 underline truncate PopupLink" role="button" tabindex="0"
                                               x-data="popup(item, 'values')" x-bind="labels"
                                               @focus="$store.codebook.currentVariableID = item.id"></a>
                                        </template>
                                    </td>
                                    {# Missings #}
                                    <td class="w-[15%] text-sm text-gray-700 max-w-0">
                                        <template
                                                x-if="$store.codebook.getOriginalVariable(item.id).missings.length === 0 || $store.codebook.getOriginalVariable(item.id).missings[0].name === ''">
                                            <button class=""
                                                    @click="$store.codebook.currentVariableID = item.id; document.querySelector(`.CodeInput_missings_${ $store.codebook.getOriginalVariable(item.id).missings.length - 1}`).focus()"
                                                    @focus="$store.codebook.currentVariableID = item.id">
                                                Add
                                            </button>
                                        </template>
                                        <template
                                                x-if="$store.codebook.getOriginalVariable(item.id).missings.length > 0 && $store.codebook.getOriginalVariable(item.id).missings[0].name !== ''">
                                            <a class="block p-1 underline truncate PopupLink" role="button" tabindex="0"
                                               x-data="popup(item, 'missings')" x-bind="labels"
                                               @focus="$store.codebook.currentVariableID = item.id"></a>
                                        </template>
                                    </td>
                                    {# Measure #}
                                    <td class="w-[10%] text-sm text-gray-700 max-w-0">
                                        <template x-if="$store.codebook.getOriginalVariable(item.id).measure === ''">
                                            <button @click="document.querySelector('#measureInput').focus();"
                                                    @focus="$store.codebook.currentVariableID = item.id">Select</a>
                                        </template>
                                        <template x-if="$store.codebook.getOriginalVariable(item.id).measure !== ''">
                                            <a role="button" tabindex="0" class="block p-1 underline truncate"
                                               x-text="$store.codebook.getOriginalVariable(item.id).measure"
                                               x-tooltip.html.theme.light-border="$store.codebook.getOriginalVariable(item.id).measure"
                                               @click="$store.codebook.currentVariableID = item.id; document.querySelector('#measureInput').focus();"
                                               @focus="$store.codebook.currentVariableID = item.id"></a>
                                        </template>
                                    </td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <aside class="col-span-full md:col-start-10 md:col-end-13"
           :class="$store.codebookSettings.showHelp.sideBar === false ? '!bg-sky-100' : ''">

        <div class="sticky w-full top-14 overflow-y-auto h-[calc(100vh-3.5rem)]"
             x-show="!$store.codebookSettings.showHelp.sideBar" x-cloak>

            <h2 class="flex items-center justify-between px-4 py-[calc(0.5rem+1px)] font-medium text-gray-700 border-t bg-sky-100 border-mono-300 text-lg">
                <span>Description of variable
                <span class="px-2 shadow bg-mono-100"
                      x-text="`${$store.codebook.getCurrentVariable().id ? $store.codebook.getCurrentVariable().id : ''}`"></span>
                </span>
                <span class="flex items-center">
                    <button title="Previous variable" class="ring-inset"
                            @click="$store.codebook.currentVariableID = $store.codebook.getPreviousVariableID(); $scroll(`#variable_${$store.codebook.currentVariableID}`, {behavior: 'smooth', offset: 160})">
                    {# Icon: carbon:caret-left #}
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                         aria-hidden="true" role="img" width="1em" height="1em" preserveAspectRatio="xMidYMid meet"
                         viewBox="0 0 32 32"><path d="M20 24l-10-8l10-8z" fill="currentColor"/></svg>
                    </button>
                    <button title="Next variable" class="ring-inset"
                            @click="$store.codebook.currentVariableID = $store.codebook.getNextVariableID(); $scroll(`#variable_${$store.codebook.currentVariableID}`, {behavior: 'smooth', offset: 160})">
                    {# Icon: carbon:caret-right #}
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                         aria-hidden="true" role="img" width="1em" height="1em" preserveAspectRatio="xMidYMid meet"
                         viewBox="0 0 32 32"><path d="M12 8l10 8l-10 8z" fill="currentColor"/></svg>
                    </button>
                </span>
            </h2>
            <div class="px-4 mt-2 text-sm text-gray-700">
                <span class="inline-block w-24 font-semibold text-right">Variable name:</span>
                <span class="ml-2"
                      x-text="$store.codebook.getCurrentVariable().name ? $store.codebook.getCurrentVariable().name : ''"></span>
            </div>
            <div class="px-4 text-sm text-gray-700">
                <span class="inline-block w-24 font-semibold text-right">Label:</span>
                <span class="ml-2"
                      x-text="$store.codebook.getCurrentVariable().label ? $store.codebook.getCurrentVariable().label : ''"></span>
            </div>
            <div class="px-4 text-sm text-gray-700">
                <span class="inline-block w-24 font-semibold text-right">Item text:</span>
                <span class="ml-2"
                      x-text="$store.codebook.getCurrentVariable().itemText ? $store.codebook.getCurrentVariable().itemText : ''"></span>
            </div>
            <div class="px-4 mt-4 text-sm text-gray-700">
                <div class="flex items-center font-semibold">Measure
                    {{ copyToVariables('measure') }}
                </div>
                <span>
                    <select name="measure" id="measureInput" x-ref="measureInput"
                            x-model="$store.codebook.getCurrentVariable().measure"
                            class="inline-block px-1 py-1 mt-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none">
                        <option value="">Select measure</option>
                        <template x-for="(measure, measureIndex) in measures" :key="measureIndex">
                            <option :value="measure" x-text="measure.substring(0,30)"
                                    :selected="measure === $store.codebook.getCurrentVariable().measure"></option>
                        </template>
                    </select>
                </span>
                <a href="/study/documentation/measures/#measures" class="ml-1 underline">Edit Measures</a>
            </div>

            <div class="px-4 mt-4 text-sm text-gray-700">
                <div class="flex items-center font-semibold">Value labels
                    {{ copyToVariables('values') }}
                </div>
                <template x-if="$store.codebook.getCurrentVariable().values">
                    {{ inputLabels({
                        'labels': '$store.codebook.getCurrentVariable().values',
                        'addText': 'Add another value label',
                        'placeHolder': '',
                        'type': 'values'
                    }) }}
                </template>
                <template x-if="!$store.codebook.getCurrentVariable().values">
                    <div>loading...</div>
                </template>
            </div>

            <div class="px-4 mt-4 text-sm text-gray-700">
                <div class="flex items-center font-semibold">Missings
                    {{ copyToVariables('missings') }}
                </div>
                <template x-if="$store.codebook.getCurrentVariable().missings">
                    {{ inputLabels({
                        'labels': '$store.codebook.getCurrentVariable().missings',
                        'addText': 'Add another missing',
                        'placeHolder': 'Label (optional)',
                        'type': 'missings'
                    }) }}
                </template>
                <template x-if="!$store.codebook.getCurrentVariable().missings">
                    <div>loading...</div>
                </template>
            </div>
        </div>

        <div class="sticky w-full top-14 overflow-y-auto max-h-[calc(100vh-3.5rem)]"
             x-show="$store.codebookSettings.showHelp.sideBar" x-transition:enter.duration.250ms>
            <div class="relative">
                <h2 class="py-3 pl-4 pr-2 text-2xl font-medium text-gray-700">Codebook editor
                    help</h2>
                <div class="absolute top-3 right-2">
                    <button class="flex items-center justify-center px-2 py-1 border-none rounded-full shadow-none bg-mono-100 hover:bg-mono-300"
                            x-on:click="$store.codebookSettings.showHelp.sideBar = false">
                        Close Help<span class="w-6 h-6 iconify" data-icon="mdi:close" data-inline="false"></span>
                    </button>
                </div>
            </div>

            <div class="ml-4 mr-2 markdown">
                {{ source("Help/codebook/_section.md")|markdown_to_html }}
            </div>

            {{ codebookHelp("variableName", "Variable names") }}
            {{ codebookHelp("variableLabel", "Variable labels") }}
            {{ codebookHelp("itemText", "Item text / Instruction") }}
            {{ codebookHelp("valueLabels", "Value labels") }}
            {{ codebookHelp("missings", "Missings") }}
            {{ codebookHelp("measure", "Measure") }}

        </div>
    </aside>
{% endblock %}
